


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > BxGyCouponStrategy</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.monk.commerce.task.strategy</a>
</div>

<h1>Coverage Summary for Class: BxGyCouponStrategy (com.monk.commerce.task.strategy)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BxGyCouponStrategy</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    58.3%
  </span>
  <span class="absValue">
    (7/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    17.2%
  </span>
  <span class="absValue">
    (11/64)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    36.2%
  </span>
  <span class="absValue">
    (54/149)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.monk.commerce.task.strategy;
&nbsp;
&nbsp;import com.monk.commerce.task.dto.request.CartItemDTO;
&nbsp;import com.monk.commerce.task.dto.request.CartRequestDTO;
&nbsp;import com.monk.commerce.task.dto.response.AppliedCouponResponseDTO;
&nbsp;import com.monk.commerce.task.dto.response.CartItemResponseDTO;
&nbsp;import com.monk.commerce.task.dto.response.UpdatedCartDTO;
&nbsp;import com.monk.commerce.task.entity.BxGyCoupon;
&nbsp;import com.monk.commerce.task.entity.Coupon;
&nbsp;import com.monk.commerce.task.entity.GetProduct;
&nbsp;import com.monk.commerce.task.exception.CouponNotApplicableException;
&nbsp;import com.monk.commerce.task.util.CartUtil;
&nbsp;import com.monk.commerce.task.util.Constants;
&nbsp;import com.monk.commerce.task.util.CouponUtil;
&nbsp;import com.monk.commerce.task.util.DiscountCalculator;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;
&nbsp;@Component
<b class="fc">&nbsp;public class BxGyCouponStrategy implements CouponStrategy {</b>
&nbsp;
<b class="fc">&nbsp;    private static final Logger log = LoggerFactory.getLogger(BxGyCouponStrategy.class);</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isApplicable(Coupon coupon, CartRequestDTO cart) {
<b class="fc">&nbsp;        Objects.requireNonNull(coupon, &quot;Coupon cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(cart, &quot;Cart cannot be null&quot;);</b>
<b class="fc">&nbsp;        if (!(coupon instanceof BxGyCoupon)) {</b>
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
<b class="pc">&nbsp;        if (CouponUtil.hasExcludedProducts(coupon, cart)) {</b>
<b class="nc">&nbsp;            log.debug(&quot;Cart contains excluded products for BxGy coupon: {}&quot;, coupon.getId());</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        BxGyCoupon bxGyCoupon = (BxGyCoupon) coupon;</b>
<b class="nc">&nbsp;        Map&lt;Long, Integer&gt; cartProductQuantities = CartUtil.getCartProductQuantities(cart);</b>
<b class="nc">&nbsp;        boolean isTiered = Boolean.TRUE.equals(bxGyCoupon.getIsTiered());</b>
<b class="nc">&nbsp;        log.debug(&quot;Checking BxGy applicability for coupon: {} (tiered: {})&quot;, coupon.getId(), isTiered);</b>
<b class="nc">&nbsp;        return isTiered ? isApplicableForTiered(bxGyCoupon, cartProductQuantities) : isApplicableForSimple(bxGyCoupon, cartProductQuantities);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public BigDecimal calculateDiscount(Coupon coupon, CartRequestDTO cart) {
<b class="fc">&nbsp;        Objects.requireNonNull(coupon, &quot;Coupon cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(cart, &quot;Cart cannot be null&quot;);</b>
<b class="fc">&nbsp;        if (!(coupon instanceof BxGyCoupon)) {</b>
<b class="fc">&nbsp;            throw new IllegalArgumentException(&quot;Invalid coupon type for BxGyCouponStrategy&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        BxGyCoupon bxGyCoupon = (BxGyCoupon) coupon;</b>
<b class="pc">&nbsp;        if (!isApplicable(coupon, cart)) {</b>
<b class="nc">&nbsp;            log.warn(&quot;BxGy coupon {} not applicable to cart&quot;, coupon.getId());</b>
<b class="nc">&nbsp;            throw new CouponNotApplicableException(Constants.BXGY_CONDITION_NOT_MET);</b>
&nbsp;        }
<b class="nc">&nbsp;        log.debug(&quot;Calculating discount for BxGy coupon: {}&quot;, coupon.getId());</b>
<b class="nc">&nbsp;        return Boolean.TRUE.equals(bxGyCoupon.getIsTiered()) ? calculateDiscountForTiered(bxGyCoupon, cart) : calculateDiscountForSimple(bxGyCoupon, cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public AppliedCouponResponseDTO applyCoupon(Coupon coupon, CartRequestDTO cart) {
<b class="fc">&nbsp;        Objects.requireNonNull(coupon, &quot;Coupon cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(cart, &quot;Cart cannot be null&quot;);</b>
<b class="fc">&nbsp;        BxGyCoupon bxGyCoupon = (BxGyCoupon) coupon;</b>
<b class="fc">&nbsp;        log.debug(&quot;Applying BxGy coupon: {} to cart&quot;, coupon.getId());</b>
<b class="pc">&nbsp;        return Boolean.TRUE.equals(bxGyCoupon.getIsTiered()) ? applyCouponForTiered(bxGyCoupon, cart) : applyCouponForSimple(bxGyCoupon, cart);</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isApplicableForSimple(BxGyCoupon coupon, Map&lt;Long, Integer&gt; cartQuantities) {
<b class="nc">&nbsp;        int buyQuantityInCart = CartUtil.calculateBuyQuantityInCart(coupon, cartQuantities, 1);</b>
<b class="nc">&nbsp;        int totalBuyQuantity = CartUtil.getTotalBuyQuantity(coupon, 1);</b>
<b class="nc">&nbsp;        log.debug(&quot;BxGy simple check - Buy quantity in cart: {}, Required: {}&quot;, buyQuantityInCart, totalBuyQuantity);</b>
<b class="nc">&nbsp;        if (buyQuantityInCart &lt; totalBuyQuantity) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return coupon.getGetProducts().stream()</b>
<b class="nc">&nbsp;                .filter(gp -&gt; gp.getTierLevel() == 1)</b>
<b class="nc">&nbsp;                .anyMatch(gp -&gt; cartQuantities.containsKey(gp.getProductId()));</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean isApplicableForTiered(BxGyCoupon coupon, Map&lt;Long, Integer&gt; cartQuantities) {
<b class="nc">&nbsp;        int maxTier = CouponUtil.getMaxTierLevel(coupon);</b>
<b class="nc">&nbsp;        log.debug(&quot;BxGy tiered check - Max tier: {}&quot;, maxTier);</b>
<b class="nc">&nbsp;        for (int tier = maxTier; tier &gt;= 1; tier--) {</b>
<b class="nc">&nbsp;            int buyQuantityInCart = CartUtil.calculateBuyQuantityInCart(coupon, cartQuantities, tier);</b>
<b class="nc">&nbsp;            int totalBuyQuantity = CartUtil.getTotalBuyQuantity(coupon, tier);</b>
<b class="nc">&nbsp;            log.debug(&quot;Checking tier {} - Buy quantity: {}, Required: {}&quot;, tier, buyQuantityInCart, totalBuyQuantity);</b>
<b class="nc">&nbsp;            if (buyQuantityInCart &gt;= totalBuyQuantity) {</b>
<b class="nc">&nbsp;                int finalTier = tier;</b>
<b class="nc">&nbsp;                boolean hasGetProducts = coupon.getGetProducts().stream()</b>
<b class="nc">&nbsp;                        .filter(gp -&gt; gp.getTierLevel() == finalTier)</b>
<b class="nc">&nbsp;                        .anyMatch(gp -&gt; cartQuantities.containsKey(gp.getProductId()));</b>
<b class="nc">&nbsp;                if (hasGetProducts) {</b>
<b class="nc">&nbsp;                    log.debug(&quot;Tier {} is applicable&quot;, tier);</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    private BigDecimal calculateDiscountForSimple(BxGyCoupon coupon, CartRequestDTO cart) {
<b class="nc">&nbsp;        Map&lt;Long, Integer&gt; cartProductQuantities = CartUtil.getCartProductQuantities(cart);</b>
<b class="nc">&nbsp;        Map&lt;Long, BigDecimal&gt; productPrices = CartUtil.getProductPrices(cart);</b>
<b class="nc">&nbsp;        int buyQuantityInCart = CartUtil.calculateBuyQuantityInCart(coupon, cartProductQuantities, 1);</b>
<b class="nc">&nbsp;        int totalBuyQuantity = CartUtil.getTotalBuyQuantity(coupon, 1);</b>
<b class="nc">&nbsp;        int possibleApplications = Math.min(buyQuantityInCart / totalBuyQuantity, coupon.getRepetitionLimit());</b>
<b class="nc">&nbsp;        log.debug(&quot;BxGy simple - Possible applications: {}&quot;, possibleApplications);</b>
<b class="nc">&nbsp;        BigDecimal totalDiscount = BigDecimal.ZERO;</b>
<b class="nc">&nbsp;        for (GetProduct getProduct : coupon.getGetProducts()) {</b>
<b class="nc">&nbsp;            if (getProduct.getTierLevel() != 1) continue;</b>
<b class="nc">&nbsp;            Long productId = getProduct.getProductId();</b>
<b class="nc">&nbsp;            Integer quantityInCart = cartProductQuantities.getOrDefault(productId, 0);</b>
<b class="nc">&nbsp;            if (quantityInCart &gt; 0) {</b>
<b class="nc">&nbsp;                int freeQuantity = Math.min(getProduct.getQuantity() * possibleApplications, quantityInCart);</b>
<b class="nc">&nbsp;                BigDecimal productPrice = productPrices.getOrDefault(productId, BigDecimal.ZERO);</b>
<b class="nc">&nbsp;                BigDecimal discount = productPrice.multiply(BigDecimal.valueOf(freeQuantity));</b>
<b class="nc">&nbsp;                totalDiscount = totalDiscount.add(discount);</b>
<b class="nc">&nbsp;                log.debug(&quot;Free quantity for product {}: {}, Discount: {}&quot;, productId, freeQuantity, discount);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        log.info(&quot;BxGy simple discount calculated: {}&quot;, totalDiscount);</b>
<b class="nc">&nbsp;        return totalDiscount;</b>
&nbsp;    }
&nbsp;
&nbsp;    private BigDecimal calculateDiscountForTiered(BxGyCoupon coupon, CartRequestDTO cart) {
<b class="nc">&nbsp;        Map&lt;Long, Integer&gt; cartProductQuantities = CartUtil.getCartProductQuantities(cart);</b>
<b class="nc">&nbsp;        Map&lt;Long, BigDecimal&gt; productPrices = CartUtil.getProductPrices(cart);</b>
<b class="nc">&nbsp;        int maxTier = CouponUtil.getMaxTierLevel(coupon);</b>
<b class="nc">&nbsp;        for (int tier = maxTier; tier &gt;= 1; tier--) {</b>
<b class="nc">&nbsp;            int buyQuantityInCart = CartUtil.calculateBuyQuantityInCart(coupon, cartProductQuantities, tier);</b>
<b class="nc">&nbsp;            int totalBuyQuantity = CartUtil.getTotalBuyQuantity(coupon, tier);</b>
<b class="nc">&nbsp;            if (buyQuantityInCart &gt;= totalBuyQuantity) {</b>
<b class="nc">&nbsp;                int possibleApplications = Math.min(buyQuantityInCart / totalBuyQuantity, coupon.getRepetitionLimit());</b>
<b class="nc">&nbsp;                log.debug(&quot;BxGy tiered - Tier {}, Possible applications: {}&quot;, tier, possibleApplications);</b>
<b class="nc">&nbsp;                BigDecimal tierDiscount = BigDecimal.ZERO;</b>
<b class="nc">&nbsp;                for (GetProduct getProduct : coupon.getGetProducts()) {</b>
<b class="nc">&nbsp;                    if (getProduct.getTierLevel() != tier) continue;</b>
<b class="nc">&nbsp;                    Long productId = getProduct.getProductId();</b>
<b class="nc">&nbsp;                    Integer quantityInCart = cartProductQuantities.getOrDefault(productId, 0);</b>
<b class="nc">&nbsp;                    if (quantityInCart &gt; 0) {</b>
<b class="nc">&nbsp;                        int freeQuantity = Math.min(getProduct.getQuantity() * possibleApplications, quantityInCart);</b>
<b class="nc">&nbsp;                        BigDecimal productPrice = productPrices.getOrDefault(productId, BigDecimal.ZERO);</b>
<b class="nc">&nbsp;                        BigDecimal discount = productPrice.multiply(BigDecimal.valueOf(freeQuantity));</b>
<b class="nc">&nbsp;                        tierDiscount = tierDiscount.add(discount);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (tierDiscount.compareTo(BigDecimal.ZERO) &gt; 0) {</b>
<b class="nc">&nbsp;                    log.info(&quot;Applied tier {} for BxGy coupon: {} with discount: {}&quot;, tier, coupon.getId(), tierDiscount);</b>
<b class="nc">&nbsp;                    return tierDiscount;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return BigDecimal.ZERO;</b>
&nbsp;    }
&nbsp;
&nbsp;    private AppliedCouponResponseDTO applyCouponForSimple(BxGyCoupon coupon, CartRequestDTO cart) {
<b class="fc">&nbsp;        Map&lt;Long, Integer&gt; cartProductQuantities = CartUtil.getCartProductQuantities(cart);</b>
<b class="fc">&nbsp;        int buyQuantityInCart = CartUtil.calculateBuyQuantityInCart(coupon, cartProductQuantities, 1);</b>
<b class="fc">&nbsp;        int totalBuyQuantity = CartUtil.getTotalBuyQuantity(coupon, 1);</b>
<b class="fc">&nbsp;        int possibleApplications = Math.min(buyQuantityInCart / totalBuyQuantity, coupon.getRepetitionLimit());</b>
<b class="fc">&nbsp;        Map&lt;Long, Integer&gt; freeQuantities = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        for (GetProduct getProduct : coupon.getGetProducts()) {</b>
<b class="pc">&nbsp;            if (getProduct.getTierLevel() != 1) continue;</b>
<b class="fc">&nbsp;            Long productId = getProduct.getProductId();</b>
<b class="fc">&nbsp;            Integer quantityInCart = cartProductQuantities.getOrDefault(productId, 0);</b>
<b class="pc">&nbsp;            if (quantityInCart &gt; 0) {</b>
<b class="fc">&nbsp;                int freeQuantity = Math.min(getProduct.getQuantity() * possibleApplications, quantityInCart);</b>
<b class="fc">&nbsp;                freeQuantities.put(productId, freeQuantity);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        log.info(&quot;Applied BxGy simple coupon with {} free items&quot;, freeQuantities.size());</b>
<b class="fc">&nbsp;        return buildResponse(cart, freeQuantities);</b>
&nbsp;    }
&nbsp;
&nbsp;    private AppliedCouponResponseDTO applyCouponForTiered(BxGyCoupon coupon, CartRequestDTO cart) {
<b class="nc">&nbsp;        Map&lt;Long, Integer&gt; cartProductQuantities = CartUtil.getCartProductQuantities(cart);</b>
<b class="nc">&nbsp;        int maxTier = CouponUtil.getMaxTierLevel(coupon);</b>
<b class="nc">&nbsp;        for (int tier = maxTier; tier &gt;= 1; tier--) {</b>
<b class="nc">&nbsp;            int buyQuantityInCart = CartUtil.calculateBuyQuantityInCart(coupon, cartProductQuantities, tier);</b>
<b class="nc">&nbsp;            int totalBuyQuantity = CartUtil.getTotalBuyQuantity(coupon, tier);</b>
<b class="nc">&nbsp;            if (buyQuantityInCart &gt;= totalBuyQuantity) {</b>
<b class="nc">&nbsp;                int possibleApplications = Math.min(buyQuantityInCart / totalBuyQuantity, coupon.getRepetitionLimit());</b>
<b class="nc">&nbsp;                Map&lt;Long, Integer&gt; freeQuantities = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;                for (GetProduct getProduct : coupon.getGetProducts()) {</b>
<b class="nc">&nbsp;                    if (getProduct.getTierLevel() != tier) continue;</b>
<b class="nc">&nbsp;                    Long productId = getProduct.getProductId();</b>
<b class="nc">&nbsp;                    Integer quantityInCart = cartProductQuantities.getOrDefault(productId, 0);</b>
<b class="nc">&nbsp;                    if (quantityInCart &gt; 0) {</b>
<b class="nc">&nbsp;                        int freeQuantity = Math.min(getProduct.getQuantity() * possibleApplications, quantityInCart);</b>
<b class="nc">&nbsp;                        freeQuantities.put(productId, freeQuantity);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                if (!freeQuantities.isEmpty()) {</b>
<b class="nc">&nbsp;                    log.info(&quot;Applied BxGy tiered coupon at tier {} with {} free items&quot;, tier, freeQuantities.size());</b>
<b class="nc">&nbsp;                    return buildResponse(cart, freeQuantities);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return buildResponse(cart, new HashMap&lt;&gt;());</b>
&nbsp;    }
&nbsp;
&nbsp;    private AppliedCouponResponseDTO buildResponse(CartRequestDTO cart, Map&lt;Long, Integer&gt; freeQuantities) {
<b class="fc">&nbsp;        BigDecimal totalDiscount = BigDecimal.ZERO;</b>
<b class="fc">&nbsp;        List&lt;CartItemResponseDTO&gt; responseItems = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        for (CartItemDTO item : cart.getItems()) {</b>
<b class="fc">&nbsp;            Integer freeQty = freeQuantities.getOrDefault(item.getProductId(), 0);</b>
<b class="fc">&nbsp;            BigDecimal itemDiscount = item.getPrice().multiply(BigDecimal.valueOf(freeQty));</b>
<b class="fc">&nbsp;            totalDiscount = totalDiscount.add(itemDiscount);</b>
<b class="fc">&nbsp;            responseItems.add(CartItemResponseDTO.builder()</b>
<b class="fc">&nbsp;                    .productId(item.getProductId())</b>
<b class="fc">&nbsp;                    .quantity(item.getQuantity())</b>
<b class="fc">&nbsp;                    .price(item.getPrice())</b>
<b class="fc">&nbsp;                    .totalDiscount(itemDiscount)</b>
<b class="fc">&nbsp;                    .build());</b>
&nbsp;        }
<b class="fc">&nbsp;        BigDecimal cartTotal = CartUtil.calculateCartTotal(cart);</b>
<b class="fc">&nbsp;        UpdatedCartDTO updatedCart = UpdatedCartDTO.builder()</b>
<b class="fc">&nbsp;                .items(responseItems)</b>
<b class="fc">&nbsp;                .totalPrice(cartTotal)</b>
<b class="fc">&nbsp;                .totalDiscount(totalDiscount)</b>
<b class="fc">&nbsp;                .finalPrice(DiscountCalculator.calculateFinalPrice(cartTotal, totalDiscount))</b>
<b class="fc">&nbsp;                .build();</b>
<b class="fc">&nbsp;        return AppliedCouponResponseDTO.builder()</b>
<b class="fc">&nbsp;                .updatedCart(updatedCart)</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-30 12:58</div>
</div>
</body>
</html>
