


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CouponMapper</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.monk.commerce.task.mapper</a>
</div>

<h1>Coverage Summary for Class: CouponMapper (com.monk.commerce.task.mapper)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CouponMapper</td>
<td class="coverageStat">
  <span class="percent">
    57.9%
  </span>
  <span class="absValue">
    (11/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    34.1%
  </span>
  <span class="absValue">
    (31/91)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60.2%
  </span>
  <span class="absValue">
    (133/221)
  </span>
</td>
</tr>
  <tr>
    <td class="name">CouponMapper$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (12/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    34.1%
  </span>
  <span class="absValue">
    (31/91)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60.4%
  </span>
  <span class="absValue">
    (134/222)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.monk.commerce.task.mapper;
&nbsp;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import com.monk.commerce.task.dto.request.BxGyDetailsDTO;
&nbsp;import com.monk.commerce.task.dto.request.BxGyProductDTO;
&nbsp;import com.monk.commerce.task.dto.request.CartWiseDetailsDTO;
&nbsp;import com.monk.commerce.task.dto.request.CouponRequestDTO;
&nbsp;import com.monk.commerce.task.dto.request.ProductWiseDetailsDTO;
&nbsp;import com.monk.commerce.task.dto.response.CouponResponseDTO;
&nbsp;import com.monk.commerce.task.entity.BuyProduct;
&nbsp;import com.monk.commerce.task.entity.BxGyCoupon;
&nbsp;import com.monk.commerce.task.entity.CartWiseCoupon;
&nbsp;import com.monk.commerce.task.entity.Coupon;
&nbsp;import com.monk.commerce.task.entity.ExcludedProduct;
&nbsp;import com.monk.commerce.task.entity.GetProduct;
&nbsp;import com.monk.commerce.task.entity.ProductWiseCoupon;
&nbsp;import com.monk.commerce.task.enums.CouponType;
&nbsp;import com.monk.commerce.task.exception.InvalidCouponException;
&nbsp;import com.monk.commerce.task.util.CouponUtil;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Optional;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Component
&nbsp;public class CouponMapper {
&nbsp;
&nbsp;    private final ObjectMapper objectMapper;
&nbsp;
<b class="fc">&nbsp;    public CouponMapper(ObjectMapper objectMapper) {</b>
<b class="fc">&nbsp;        this.objectMapper = objectMapper;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Coupon toEntity(CouponRequestDTO dto) {
<b class="fc">&nbsp;        Objects.requireNonNull(dto, &quot;CouponRequestDTO cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(dto.getType(), &quot;Coupon type cannot be null&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        CouponType couponType = CouponType.fromValue(dto.getType());</b>
<b class="pc">&nbsp;        Coupon coupon = switch (couponType) {</b>
<b class="fc">&nbsp;            case CART_WISE -&gt; toCartWiseCoupon(dto);</b>
<b class="fc">&nbsp;            case PRODUCT_WISE -&gt; toProductWiseCoupon(dto);</b>
<b class="fc">&nbsp;            case BXGY -&gt; toBxGyCoupon(dto);</b>
<b class="fc">&nbsp;            default -&gt; throw new InvalidCouponException(&quot;Unsupported coupon type: &quot; + dto.getType());</b>
&nbsp;        };
&nbsp;
&nbsp;        // Set usage limits and priority
<b class="pc">&nbsp;        if (dto.getMaxUsageLimit() != null) {</b>
<b class="nc">&nbsp;            coupon.setMaxUsageLimit(dto.getMaxUsageLimit());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getUsageLimitPerUser() != null) {</b>
<b class="nc">&nbsp;            coupon.setUsageLimitPerUser(dto.getUsageLimitPerUser());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getAllowStacking() != null) {</b>
<b class="nc">&nbsp;            coupon.setAllowStacking(dto.getAllowStacking());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getPriority() != null) {</b>
<b class="nc">&nbsp;            coupon.setPriority(dto.getPriority());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Set excluded products
<b class="pc">&nbsp;        if (dto.getExcludedProducts() != null &amp;&amp; !dto.getExcludedProducts().isEmpty()) {</b>
<b class="nc">&nbsp;            List&lt;ExcludedProduct&gt; excludedProducts = dto.getExcludedProducts().stream()</b>
<b class="nc">&nbsp;                    .map(productId -&gt; ExcludedProduct.builder()</b>
<b class="nc">&nbsp;                            .coupon(coupon)</b>
<b class="nc">&nbsp;                            .productId(productId)</b>
<b class="nc">&nbsp;                            .build())</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;            coupon.setExcludedProducts(excludedProducts);</b>
&nbsp;        }
<b class="fc">&nbsp;        return coupon;</b>
&nbsp;    }
&nbsp;
&nbsp;    private CartWiseCoupon toCartWiseCoupon(CouponRequestDTO dto) {
<b class="fc">&nbsp;        CartWiseDetailsDTO details = objectMapper.convertValue(dto.getDetails(), CartWiseDetailsDTO.class);</b>
&nbsp;
<b class="fc">&nbsp;        Objects.requireNonNull(details, &quot;Cart-wise details cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getThreshold(), &quot;Threshold cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getDiscountPercentage(), &quot;Discount percentage cannot be null&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        return CartWiseCoupon.builder()</b>
<b class="pc">&nbsp;                .couponCode(dto.getCouponCode() != null ? dto.getCouponCode() : CouponUtil.generateCouponCode())</b>
<b class="fc">&nbsp;                .type(CouponType.CART_WISE)</b>
<b class="fc">&nbsp;                .description(dto.getDescription())</b>
<b class="fc">&nbsp;                .isActive(Optional.ofNullable(dto.getIsActive()).orElse(true))</b>
<b class="fc">&nbsp;                .expirationDate(dto.getExpirationDate())</b>
<b class="fc">&nbsp;                .thresholdAmount(details.getThreshold())</b>
<b class="fc">&nbsp;                .discountPercentage(details.getDiscountPercentage())</b>
<b class="fc">&nbsp;                .maxDiscountAmount(details.getMaxDiscount())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private ProductWiseCoupon toProductWiseCoupon(CouponRequestDTO dto) {
<b class="fc">&nbsp;        ProductWiseDetailsDTO details = objectMapper.convertValue(dto.getDetails(), ProductWiseDetailsDTO.class);</b>
&nbsp;
<b class="fc">&nbsp;        Objects.requireNonNull(details, &quot;Product-wise details cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getProductId(), &quot;Product ID cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getDiscount(), &quot;Discount cannot be null&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        return ProductWiseCoupon.builder()</b>
<b class="pc">&nbsp;                .couponCode(dto.getCouponCode() != null ? dto.getCouponCode() : CouponUtil.generateCouponCode())</b>
<b class="fc">&nbsp;                .type(CouponType.PRODUCT_WISE)</b>
<b class="fc">&nbsp;                .description(dto.getDescription())</b>
<b class="fc">&nbsp;                .isActive(Optional.ofNullable(dto.getIsActive()).orElse(true))</b>
<b class="fc">&nbsp;                .expirationDate(dto.getExpirationDate())</b>
<b class="fc">&nbsp;                .productId(details.getProductId())</b>
<b class="fc">&nbsp;                .discountPercentage(details.getDiscount())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private BxGyCoupon toBxGyCoupon(CouponRequestDTO dto) {
<b class="fc">&nbsp;        BxGyDetailsDTO details = objectMapper.convertValue(dto.getDetails(), BxGyDetailsDTO.class);</b>
&nbsp;
<b class="fc">&nbsp;        Objects.requireNonNull(details, &quot;BxGy details cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getBuyProducts(), &quot;Buy products cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getGetProducts(), &quot;Get products cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(details.getRepetitionLimit(), &quot;Repetition limit cannot be null&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        BxGyCoupon bxGyCoupon = BxGyCoupon.builder()</b>
<b class="pc">&nbsp;                .couponCode(dto.getCouponCode() != null ? dto.getCouponCode() : CouponUtil.generateCouponCode())</b>
<b class="fc">&nbsp;                .type(CouponType.BXGY)</b>
<b class="fc">&nbsp;                .description(dto.getDescription())</b>
<b class="fc">&nbsp;                .isActive(Optional.ofNullable(dto.getIsActive()).orElse(true))</b>
<b class="fc">&nbsp;                .expirationDate(dto.getExpirationDate())</b>
<b class="fc">&nbsp;                .repetitionLimit(details.getRepetitionLimit())</b>
<b class="fc">&nbsp;                .buyProducts(new ArrayList&lt;&gt;())</b>
<b class="fc">&nbsp;                .getProducts(new ArrayList&lt;&gt;())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;
<b class="fc">&nbsp;        details.getBuyProducts().forEach(buyProductDTO -&gt; {</b>
<b class="fc">&nbsp;            BuyProduct buyProduct = BuyProduct.builder()</b>
<b class="fc">&nbsp;                    .productId(buyProductDTO.getProductId())</b>
<b class="fc">&nbsp;                    .quantity(buyProductDTO.getQuantity())</b>
<b class="fc">&nbsp;                    .tierLevel(Optional.ofNullable(buyProductDTO.getTierLevel()).orElse(1))</b>
<b class="fc">&nbsp;                    .bxgyCoupon(bxGyCoupon)</b>
<b class="fc">&nbsp;                    .build();</b>
<b class="fc">&nbsp;            bxGyCoupon.getBuyProducts().add(buyProduct);</b>
&nbsp;        });
&nbsp;
<b class="fc">&nbsp;        details.getGetProducts().forEach(getProductDTO -&gt; {</b>
<b class="fc">&nbsp;            GetProduct getProduct = GetProduct.builder()</b>
<b class="fc">&nbsp;                    .productId(getProductDTO.getProductId())</b>
<b class="fc">&nbsp;                    .quantity(getProductDTO.getQuantity())</b>
<b class="fc">&nbsp;                    .tierLevel(Optional.ofNullable(getProductDTO.getTierLevel()).orElse(1))</b>
<b class="fc">&nbsp;                    .bxgyCoupon(bxGyCoupon)</b>
<b class="fc">&nbsp;                    .build();</b>
<b class="fc">&nbsp;            bxGyCoupon.getGetProducts().add(getProduct);</b>
&nbsp;        });
&nbsp;
<b class="pc">&nbsp;        boolean isTiered = bxGyCoupon.getBuyProducts().stream().anyMatch(bp -&gt; bp.getTierLevel() &gt; 1) ||</b>
<b class="pc">&nbsp;                bxGyCoupon.getGetProducts().stream().anyMatch(gp -&gt; gp.getTierLevel() &gt; 1);</b>
<b class="fc">&nbsp;        bxGyCoupon.setIsTiered(isTiered);</b>
<b class="fc">&nbsp;        return bxGyCoupon;</b>
&nbsp;    }
&nbsp;
&nbsp;    public CouponResponseDTO toResponseDTO(Coupon coupon) {
<b class="fc">&nbsp;        Objects.requireNonNull(coupon, &quot;Coupon cannot be null&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        List&lt;Long&gt; excludedProductIds = null;</b>
<b class="pc">&nbsp;        if (coupon.getExcludedProducts() != null &amp;&amp; !coupon.getExcludedProducts().isEmpty()) {</b>
<b class="fc">&nbsp;            excludedProductIds = coupon.getExcludedProducts().stream()</b>
<b class="fc">&nbsp;                    .map(ExcludedProduct::getProductId)</b>
<b class="fc">&nbsp;                    .collect(Collectors.toList());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return CouponResponseDTO.builder()</b>
<b class="fc">&nbsp;                .id(coupon.getId())</b>
<b class="fc">&nbsp;                .couponCode(coupon.getCouponCode())</b>
<b class="fc">&nbsp;                .type(coupon.getType().getValue())</b>
<b class="fc">&nbsp;                .description(coupon.getDescription())</b>
<b class="fc">&nbsp;                .isActive(coupon.getIsActive())</b>
<b class="fc">&nbsp;                .expirationDate(coupon.getExpirationDate())</b>
<b class="fc">&nbsp;                .usageCount(coupon.getUsageCount())</b>
<b class="fc">&nbsp;                .maxUsageLimit(coupon.getMaxUsageLimit())</b>
<b class="fc">&nbsp;                .usageLimitPerUser(coupon.getUsageLimitPerUser())</b>
<b class="fc">&nbsp;                .allowStacking(coupon.getAllowStacking())</b>
<b class="fc">&nbsp;                .priority(coupon.getPriority())</b>
<b class="fc">&nbsp;                .details(mapCouponDetails(coupon))</b>
<b class="fc">&nbsp;                .excludedProducts(excludedProductIds) // ADD THIS</b>
<b class="fc">&nbsp;                .createdAt(coupon.getCreatedAt())</b>
<b class="fc">&nbsp;                .updatedAt(coupon.getUpdatedAt())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    private Object mapCouponDetails(Coupon coupon) {
<b class="fc">&nbsp;        Objects.requireNonNull(coupon, &quot;Coupon cannot be null&quot;);</b>
&nbsp;
<b class="pc">&nbsp;        if (coupon instanceof CartWiseCoupon) {</b>
<b class="fc">&nbsp;            CartWiseCoupon cartWiseCoupon = (CartWiseCoupon) coupon;</b>
<b class="fc">&nbsp;            return CartWiseDetailsDTO.builder()</b>
<b class="fc">&nbsp;                    .threshold(cartWiseCoupon.getThresholdAmount())</b>
<b class="fc">&nbsp;                    .discountPercentage(cartWiseCoupon.getDiscountPercentage())</b>
<b class="fc">&nbsp;                    .maxDiscount(cartWiseCoupon.getMaxDiscountAmount())</b>
<b class="fc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;        } else if (coupon instanceof ProductWiseCoupon) {</b>
<b class="nc">&nbsp;            ProductWiseCoupon productWiseCoupon = (ProductWiseCoupon) coupon;</b>
<b class="nc">&nbsp;            return ProductWiseDetailsDTO.builder()</b>
<b class="nc">&nbsp;                    .productId(productWiseCoupon.getProductId())</b>
<b class="nc">&nbsp;                    .discount(productWiseCoupon.getDiscountPercentage())</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;        } else if (coupon instanceof BxGyCoupon) {</b>
<b class="nc">&nbsp;            BxGyCoupon bxGyCoupon = (BxGyCoupon) coupon;</b>
&nbsp;
<b class="nc">&nbsp;            List&lt;BxGyProductDTO&gt; buyProducts = bxGyCoupon.getBuyProducts().stream()</b>
<b class="nc">&nbsp;                    .map(bp -&gt; BxGyProductDTO.builder()</b>
<b class="nc">&nbsp;                            .productId(bp.getProductId())</b>
<b class="nc">&nbsp;                            .quantity(bp.getQuantity())</b>
<b class="nc">&nbsp;                            .tierLevel(bp.getTierLevel())</b>
<b class="nc">&nbsp;                            .build())</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
&nbsp;
<b class="nc">&nbsp;            List&lt;BxGyProductDTO&gt; getProducts = bxGyCoupon.getGetProducts().stream()</b>
<b class="nc">&nbsp;                    .map(gp -&gt; BxGyProductDTO.builder()</b>
<b class="nc">&nbsp;                            .productId(gp.getProductId())</b>
<b class="nc">&nbsp;                            .quantity(gp.getQuantity())</b>
<b class="nc">&nbsp;                            .tierLevel(gp.getTierLevel())</b>
<b class="nc">&nbsp;                            .build())</b>
<b class="nc">&nbsp;                    .collect(Collectors.toList());</b>
&nbsp;
<b class="nc">&nbsp;            return BxGyDetailsDTO.builder()</b>
<b class="nc">&nbsp;                    .buyProducts(buyProducts)</b>
<b class="nc">&nbsp;                    .getProducts(getProducts)</b>
<b class="nc">&nbsp;                    .repetitionLimit(bxGyCoupon.getRepetitionLimit())</b>
<b class="nc">&nbsp;                    .build();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void updateEntity(Coupon existingCoupon, CouponRequestDTO dto) {
<b class="fc">&nbsp;        Objects.requireNonNull(existingCoupon, &quot;Existing coupon cannot be null&quot;);</b>
<b class="fc">&nbsp;        Objects.requireNonNull(dto, &quot;CouponRequestDTO cannot be null&quot;);</b>
&nbsp;
<b class="pc">&nbsp;        if (dto.getCouponCode() != null) {</b>
<b class="fc">&nbsp;            existingCoupon.setCouponCode(dto.getCouponCode());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getDescription() != null) {</b>
<b class="fc">&nbsp;            existingCoupon.setDescription(dto.getDescription());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getIsActive() != null) {</b>
<b class="fc">&nbsp;            existingCoupon.setIsActive(dto.getIsActive());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getExpirationDate() != null) {</b>
<b class="nc">&nbsp;            existingCoupon.setExpirationDate(dto.getExpirationDate());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getMaxUsageLimit() != null) {</b>
<b class="fc">&nbsp;            existingCoupon.setMaxUsageLimit(dto.getMaxUsageLimit());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getUsageLimitPerUser() != null) {</b>
<b class="nc">&nbsp;            existingCoupon.setUsageLimitPerUser(dto.getUsageLimitPerUser());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getAllowStacking() != null) {</b>
<b class="nc">&nbsp;            existingCoupon.setAllowStacking(dto.getAllowStacking());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (dto.getPriority() != null) {</b>
<b class="nc">&nbsp;            existingCoupon.setPriority(dto.getPriority());</b>
&nbsp;        }
&nbsp;        // Update excluded products
<b class="pc">&nbsp;        if (dto.getExcludedProducts() != null) {</b>
<b class="nc">&nbsp;            existingCoupon.getExcludedProducts().clear();</b>
<b class="nc">&nbsp;            if (!dto.getExcludedProducts().isEmpty()) {</b>
<b class="nc">&nbsp;                List&lt;ExcludedProduct&gt; excludedProducts = dto.getExcludedProducts().stream()</b>
<b class="nc">&nbsp;                        .map(productId -&gt; ExcludedProduct.builder()</b>
<b class="nc">&nbsp;                                .coupon(existingCoupon)</b>
<b class="nc">&nbsp;                                .productId(productId)</b>
<b class="nc">&nbsp;                                .build())</b>
<b class="nc">&nbsp;                        .collect(Collectors.toList());</b>
<b class="nc">&nbsp;                existingCoupon.getExcludedProducts().addAll(excludedProducts);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="pc">&nbsp;        if (dto.getDetails() != null) {</b>
<b class="pc">&nbsp;            if (existingCoupon instanceof CartWiseCoupon) {</b>
<b class="nc">&nbsp;                updateCartWiseCoupon((CartWiseCoupon) existingCoupon, dto);</b>
<b class="pc">&nbsp;            } else if (existingCoupon instanceof ProductWiseCoupon) {</b>
<b class="fc">&nbsp;                updateProductWiseCoupon((ProductWiseCoupon) existingCoupon, dto);</b>
<b class="nc">&nbsp;            } else if (existingCoupon instanceof BxGyCoupon) {</b>
<b class="nc">&nbsp;                updateBxGyCoupon((BxGyCoupon) existingCoupon, dto);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateCartWiseCoupon(CartWiseCoupon coupon, CouponRequestDTO dto) {
<b class="nc">&nbsp;        CartWiseDetailsDTO details = objectMapper.convertValue(dto.getDetails(), CartWiseDetailsDTO.class);</b>
&nbsp;
<b class="nc">&nbsp;        if (details.getThreshold() != null) {</b>
<b class="nc">&nbsp;            coupon.setThresholdAmount(details.getThreshold());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (details.getDiscountPercentage() != null) {</b>
<b class="nc">&nbsp;            coupon.setDiscountPercentage(details.getDiscountPercentage());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (details.getMaxDiscount() != null) {</b>
<b class="nc">&nbsp;            coupon.setMaxDiscountAmount(details.getMaxDiscount());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateProductWiseCoupon(ProductWiseCoupon coupon, CouponRequestDTO dto) {
<b class="fc">&nbsp;        ProductWiseDetailsDTO details = objectMapper.convertValue(dto.getDetails(), ProductWiseDetailsDTO.class);</b>
&nbsp;
<b class="pc">&nbsp;        if (details.getProductId() != null) {</b>
<b class="fc">&nbsp;            coupon.setProductId(details.getProductId());</b>
&nbsp;        }
<b class="pc">&nbsp;        if (details.getDiscount() != null) {</b>
<b class="fc">&nbsp;            coupon.setDiscountPercentage(details.getDiscount());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void updateBxGyCoupon(BxGyCoupon coupon, CouponRequestDTO dto) {
<b class="nc">&nbsp;        BxGyDetailsDTO details = objectMapper.convertValue(dto.getDetails(), BxGyDetailsDTO.class);</b>
&nbsp;
<b class="nc">&nbsp;        if (details.getRepetitionLimit() != null) {</b>
<b class="nc">&nbsp;            coupon.setRepetitionLimit(details.getRepetitionLimit());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (details.getBuyProducts() != null &amp;&amp; !details.getBuyProducts().isEmpty()) {</b>
<b class="nc">&nbsp;            coupon.getBuyProducts().clear();</b>
<b class="nc">&nbsp;            details.getBuyProducts().forEach(buyProductDTO -&gt; {</b>
<b class="nc">&nbsp;                BuyProduct buyProduct = BuyProduct.builder()</b>
<b class="nc">&nbsp;                        .productId(buyProductDTO.getProductId())</b>
<b class="nc">&nbsp;                        .quantity(buyProductDTO.getQuantity())</b>
<b class="nc">&nbsp;                        .tierLevel(Optional.ofNullable(buyProductDTO.getTierLevel()).orElse(1))</b>
<b class="nc">&nbsp;                        .bxgyCoupon(coupon)</b>
<b class="nc">&nbsp;                        .build();</b>
<b class="nc">&nbsp;                coupon.getBuyProducts().add(buyProduct);</b>
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (details.getGetProducts() != null &amp;&amp; !details.getGetProducts().isEmpty()) {</b>
<b class="nc">&nbsp;            coupon.getGetProducts().clear();</b>
<b class="nc">&nbsp;            details.getGetProducts().forEach(getProductDTO -&gt; {</b>
<b class="nc">&nbsp;                GetProduct getProduct = GetProduct.builder()</b>
<b class="nc">&nbsp;                        .productId(getProductDTO.getProductId())</b>
<b class="nc">&nbsp;                        .quantity(getProductDTO.getQuantity())</b>
<b class="nc">&nbsp;                        .tierLevel(Optional.ofNullable(getProductDTO.getTierLevel()).orElse(1))</b>
<b class="nc">&nbsp;                        .bxgyCoupon(coupon)</b>
<b class="nc">&nbsp;                        .build();</b>
<b class="nc">&nbsp;                coupon.getGetProducts().add(getProduct);</b>
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        boolean isTiered = coupon.getBuyProducts().stream().anyMatch(bp -&gt; bp.getTierLevel() &gt; 1) ||</b>
<b class="nc">&nbsp;                coupon.getGetProducts().stream().anyMatch(gp -&gt; gp.getTierLevel() &gt; 1);</b>
<b class="nc">&nbsp;        coupon.setIsTiered(isTiered);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-30 12:58</div>
</div>
</body>
</html>
